<!DOCTYPE html>
<html>
<head>
    <title>HTTPS Reading Tracker Bookmarklet</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .bookmarklet {
            background: #007aff;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin: 20px 0;
        }
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .info {
            background: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <h1>üîí HTTPS Reading Tracker Bookmarklet</h1>
    
    <div class="alert">
        <strong>‚ö†Ô∏è Mixed Content Issue Detected!</strong><br>
        You were on an HTTPS site trying to connect to HTTP. This is blocked by browsers for security.
        <br><br>
        <strong>Solution:</strong> Use the HTTPS version of the API (port 3003) with a self-signed certificate.
    </div>
    
    <div class="alert info">
        <strong>üìã Setup Instructions:</strong>
        <ol>
            <li><strong>Restart your Reading Tracker app</strong> (it now runs on both HTTP and HTTPS)</li>
            <li><strong>Trust the self-signed certificate</strong> (one-time setup)</li>
            <li><strong>Use the HTTPS bookmarklet below</strong></li>
        </ol>
    </div>
    
    <h3>Step 1: Trust the Certificate</h3>
    <p>Click this link to trust the self-signed certificate:</p>
    <a href="https://127.0.0.1:3003/test" target="_blank" style="background: #ffc107; color: #212529; padding: 10px 15px; border-radius: 5px; text-decoration: none;">üîê Trust Certificate (https://127.0.0.1:3003)</a>
    
    <p><em>Safari will show a security warning. Click "Advanced" ‚Üí "Proceed to 127.0.0.1" to trust it.</em></p>
    
    <h3>Step 2: Use the HTTPS Bookmarklet</h3>
    <p>Once you've trusted the certificate, drag this bookmarklet to your bookmarks bar:</p>
    
    <a href="javascript:(function(){
        console.log('üìö Reading Tracker HTTPS Bookmarklet Started');
        
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.style.cssText = `position:fixed;top:20px;right:20px;background:${isError ? '#f44336' : '#4CAF50'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
        
        showNotification('üîÑ Starting article save (HTTPS)...');
        
        fetch('https://127.0.0.1:3003/api/ping')
        .then(response => {
            console.log('HTTPS API ping response:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('HTTPS API connected:', data);
            showNotification('‚úÖ Connected via HTTPS, extracting...');
            
            const title = document.querySelector('h1, .title, [class*=title], [class*=headline]')?.textContent || document.title;
            const contentEl = document.querySelector('article, .content, .post, .entry, main') || document.body;
            const content = contentEl.innerHTML;
            const textContent = contentEl.textContent;
            const wordCount = textContent.split(/\\s+/).filter(w => w.length > 0).length;
            const author = document.querySelector('[class*=author], .byline, [rel=author]')?.textContent || null;
            
            const articleData = {
                url: window.location.href,
                title: title.trim(),
                author: author ? author.trim() : null,
                publishDate: new Date().toISOString(),
                content: content,
                textContent: textContent.trim(),
                wordCount: wordCount,
                readingTime: 0
            };
            
            showNotification('üì° Saving via HTTPS...');
            
            return fetch('https://127.0.0.1:3003/api/articles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(articleData)
            });
        })
        .then(response => {
            console.log('HTTPS save response:', response.status);
            if (!response.ok) throw new Error(`Save failed: HTTP ${response.status}`);
            return response.json();
        })
        .then(result => {
            console.log('HTTPS save result:', result);
            showNotification(`‚úÖ Article saved via HTTPS! (ID: ${result.id})`);
        })
        .catch(error => {
            console.error('HTTPS Error:', error);
            if (error.message.includes('certificate') || error.message.includes('SSL') || error.message.includes('security')) {
                showNotification('üîê Certificate not trusted. Visit https://127.0.0.1:3003/test first!', true);
            } else {
                showNotification(`‚ùå Error: ${error.message}`, true);
            }
        });
    })()" class="bookmarklet">üìö Save Article (HTTPS)</a>
    
    <h3>Alternative: HTTP-Only Sites</h3>
    <p>For HTTP sites (non-HTTPS), you can still use the original HTTP version:</p>
    
    <a href="javascript:(function(){
        const isHttps = window.location.protocol === 'https:';
        const apiUrl = isHttps ? 'https://127.0.0.1:3003' : 'http://127.0.0.1:3002';
        
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.style.cssText = `position:fixed;top:20px;right:20px;background:${isError ? '#f44336' : '#4CAF50'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
        
        showNotification(`üîÑ Starting save (${isHttps ? 'HTTPS' : 'HTTP'})...`);
        
        fetch(`${apiUrl}/api/ping`)
        .then(response => response.json())
        .then(data => {
            const title = document.querySelector('h1, .title, [class*=title], [class*=headline]')?.textContent || document.title;
            const contentEl = document.querySelector('article, .content, .post, .entry, main') || document.body;
            const content = contentEl.innerHTML;
            const textContent = contentEl.textContent;
            const wordCount = textContent.split(/\\s+/).filter(w => w.length > 0).length;
            const author = document.querySelector('[class*=author], .byline, [rel=author]')?.textContent || null;
            
            const articleData = {
                url: window.location.href,
                title: title.trim(),
                author: author ? author.trim() : null,
                publishDate: new Date().toISOString(),
                content: content,
                textContent: textContent.trim(),
                wordCount: wordCount,
                readingTime: 0
            };
            
            return fetch(`${apiUrl}/api/articles`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(articleData)
            });
        })
        .then(response => response.json())
        .then(result => {
            showNotification(`‚úÖ Article saved! (${isHttps ? 'HTTPS' : 'HTTP'})`);
        })
        .catch(error => {
            if (isHttps && error.message.includes('certificate')) {
                showNotification('üîê Visit https://127.0.0.1:3003/test to trust certificate first!', true);
            } else {
                showNotification(`‚ùå Error: ${error.message}`, true);
            }
        });
    })()" class="bookmarklet">üìö Auto-Detect Protocol</a>
    
    <div class="alert success">
        <strong>‚úÖ How It Works:</strong><br>
        ‚Ä¢ <strong>HTTPS sites</strong>: Uses port 3003 with SSL certificate<br>
        ‚Ä¢ <strong>HTTP sites</strong>: Uses port 3002 (original)<br>
        ‚Ä¢ <strong>Auto-detect</strong>: Chooses the right protocol automatically
    </div>
    
    <h3>üîß Troubleshooting</h3>
    <ul>
        <li><strong>Certificate error:</strong> Visit <a href="https://127.0.0.1:3003/test" target="_blank">https://127.0.0.1:3003/test</a> and accept the security warning</li>
        <li><strong>Connection refused:</strong> Make sure the Reading Tracker app is running</li>
        <li><strong>No notifications:</strong> Check Safari's JavaScript console for errors</li>
    </ul>
</body>
</html>