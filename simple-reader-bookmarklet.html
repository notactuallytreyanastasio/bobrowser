<!DOCTYPE html>
<html>
<head>
    <title>üìñ Reader View Bookmarklet</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .bookmarklet {
            background: #007aff;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            display: inline-block;
            margin: 30px 0;
            cursor: grab;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        .bookmarklet:hover {
            background: #0056b3;
        }
        .instructions {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007aff;
        }
    </style>
</head>
<body>
    <h1>üìñ Reader View Article Saver</h1>
    
    <div class="instructions">
        <h3>üìã Instructions:</h3>
        <ol>
            <li><strong>Drag</strong> the blue button below to your Safari bookmarks bar</li>
            <li>Visit any article and switch to <strong>Reader View</strong></li>
            <li>Click the bookmarklet to save the article</li>
            <li>Open Web Inspector (Develop menu) to see detailed logs</li>
        </ol>
    </div>
    
    <p><strong>‚ö†Ô∏è Important:</strong> This only works in Safari Reader View mode!</p>
    
    <a href="javascript:(function(){console.log('üìñ Reader View Bookmarklet Started');function showNotification(message,isError=false){const notification=document.createElement('div');notification.style.cssText=`position:fixed;top:20px;right:20px;background:${isError?'#f44336':'#4CAF50'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>notification.remove(),4000)}function detectReaderView(){return window.location.protocol==='safari-reader:'||document.body.classList.contains('safari-reader')||document.querySelector('body[data-safari-reader]')||window.location.href.includes('safari-reader://')}function getOriginalURL(){const metaUrl=document.querySelector('meta[property=\"og:url\"]')?.content||document.querySelector('meta[name=\"twitter:url\"]')?.content||document.querySelector('link[rel=\"canonical\"]')?.href;if(metaUrl)return metaUrl;const titleMatch=document.title.match(/https?:\\/\\/[^\\s]+/);if(titleMatch)return titleMatch[0];const userUrl=prompt('üìñ Reader View detected! Please paste the original article URL:',window.location.href);return userUrl||window.location.href}function extractContent(){const isReader=detectReaderView();console.log('üîç Reader view detected:',isReader);if(isReader){showNotification('üìñ Reader View detected, adapting...');console.log('üìñ Processing reader view content...');const titleSelectors=['h1','.title','[class*=title]','[data-testid*=title]'];let title=null;for(const selector of titleSelectors){const el=document.querySelector(selector);if(el&&el.textContent.trim().length>3){title=el.textContent.trim();console.log(`üìù Found title with selector ${selector}:`,title.substring(0,50));break}}if(!title){title=document.title.replace(/\\s*[-|]\\s*.*$/,'').trim();console.log('üìù Fallback to document title:',title.substring(0,50))}const contentSelectors=['article','[role=\"main\"]','.content','.article-content','.post-content','main','body'];let contentEl=null;for(const selector of contentSelectors){const el=document.querySelector(selector);if(el){console.log(`üìÑ Found content with selector: ${selector}`);contentEl=el;break}}const content=contentEl?contentEl.innerHTML:document.body.innerHTML;const textContent=contentEl?contentEl.textContent:document.body.textContent;console.log('üìÑ Content extraction stats:',{htmlLength:content.length,textLength:textContent.length,selector:contentEl?.tagName+(contentEl?.className?'.'+contentEl.className:'')});const originalUrl=getOriginalURL();console.log('üîó Original URL resolved:',originalUrl);return{url:originalUrl,title:title,content:content,textContent:textContent.trim(),isReaderView:true}}else{console.log('üåê Processing regular page content...');console.log('‚ö†Ô∏è Non-reader page detected - skipping as per requirements');throw new Error('This bookmarklet only works with Reader View pages. Please switch to Reader View first.')}}try{showNotification('üîÑ Starting article save...');console.log('üìñ Reader View Compatible Bookmarklet - Starting extraction');const extracted=extractContent();console.log('üîç Raw extraction result:',{url:extracted.url,title:extracted.title,contentLength:extracted.content?.length||0,textContentLength:extracted.textContent?.length||0,isReaderView:extracted.isReaderView});const cleanText=extracted.textContent.replace(/\\s+/g,' ').replace(/[\\u00A0\\u2000-\\u200B\\u2028-\\u2029\\u202F\\u205F\\u3000]/g,' ').trim();console.log('üßπ Cleaned text preview:',cleanText.substring(0,200)+'...');const wordCount=cleanText.split(/\\s+/).filter(w=>w.length>0).length;console.log('üìä Word count:',wordCount);const author=document.querySelector('[class*=author], .byline, [rel=author]')?.textContent||null;const articleData={url:extracted.url,title:extracted.title,author:author?author.trim():null,publishDate:new Date().toISOString(),content:extracted.content,textContent:cleanText,wordCount:wordCount,readingTime:Math.ceil(wordCount/200)*1000,tags:extracted.isReaderView?'reader-view':null};console.log('üìÑ Final article data:',{...articleData,content:articleData.content?.substring(0,100)+'...',textContent:articleData.textContent?.substring(0,100)+'...'});if(!articleData.title||articleData.title.length<3){console.error('‚ùå Title validation failed:',articleData.title);throw new Error('Could not extract article title')}if(!articleData.textContent||articleData.textContent.length<50){console.error('‚ùå Content validation failed - too short:',articleData.textContent?.length);throw new Error('Article content too short to be meaningful')}if(wordCount<10){console.error('‚ùå Word count validation failed:',wordCount);throw new Error('Article has too few words')}showNotification('üì° Saving to Reading Tracker...');const endpoints=['https://127.0.0.1:3003/api/articles','http://127.0.0.1:3002/api/articles'];let saved=false;for(const endpoint of endpoints){try{console.log(`üîó Attempting to save via ${endpoint}`);const response=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(articleData)});console.log(`üì° Response status: ${response.status} ${response.statusText}`);if(response.ok){const result=await response.json();console.log('‚úÖ Article saved successfully:',result);showNotification(`‚úÖ Article saved! ${wordCount} words, ${Math.ceil(wordCount/200)} min read`);saved=true;break}else{const errorText=await response.text();console.error(`‚ùå Server error (${response.status}):`,errorText)}}catch(e){console.error(`‚ùå Failed to save via ${endpoint}:`,e.message);continue}}if(!saved){throw new Error('Could not connect to Reading Tracker API')}}catch(error){console.error('Bookmarklet error:',error);showNotification(`‚ùå Error: ${error.message}`,true)}})();" class="bookmarklet">üìñ Save Article (Reader View)</a>
    
    <h3>‚úÖ What this does:</h3>
    <ul>
        <li>Only works in Safari Reader View (enforced)</li>
        <li>Extracts clean article content and metadata</li>
        <li>Comprehensive logging for debugging</li>
        <li>Validates content quality before saving</li>
        <li>Shows success/error notifications</li>
    </ul>
    
</body>
</html>