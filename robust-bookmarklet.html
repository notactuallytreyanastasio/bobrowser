<!DOCTYPE html>
<html>
<head>
    <title>üìñ Robust Reader Bookmarklet</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-box {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            word-break: break-all;
            margin: 10px 0;
        }
        .button {
            background: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üìñ Robust Reader Bookmarklet</h1>
    
    <div class="warning">
        <strong>üõ†Ô∏è Fixed Version</strong><br>
        This version includes better error handling and null-safety checks to prevent JavaScript errors.
    </div>
    
    <div class="step">
        <h3>Step 1: Create Bookmark</h3>
        <ol>
            <li>In Safari: <strong>Bookmarks ‚Üí Add Bookmark</strong></li>
            <li>Name: <strong>üìñ Reader Save</strong></li>
            <li>URL: <code>about:blank</code></li>
            <li>Click <strong>Add</strong></li>
        </ol>
    </div>
    
    <div class="step">
        <h3>Step 2: Edit Bookmark URL</h3>
        <p>Replace the bookmark URL with this robust code:</p>
        
        <div class="code-box" id="bookmarkletCode">
javascript:(function(){try{function log(msg){console.log('üìñ Reader Bookmarklet: '+msg)}function showMsg(text,isErr){try{var d=document.createElement('div');if(!d)return;d.style.cssText='position:fixed;top:20px;right:20px;background:'+(isErr?'#f44336':'#4CAF50')+';color:white;padding:15px 20px;border-radius:8px;z-index:10000;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;';d.textContent=text||'Unknown message';if(document.body){document.body.appendChild(d);setTimeout(function(){try{if(d&&d.parentNode)d.parentNode.removeChild(d)}catch(e){}},4000)}else{alert(text)}}catch(e){alert(text||'Error')}}log('Starting...');if(!(window.location.protocol==='safari-reader:'||document.body&&document.body.classList&&document.body.classList.contains('safari-reader')||(document.querySelector&&document.querySelector('body[data-safari-reader]'))||window.location.href.includes('safari-reader://'))){showMsg('‚ùå Reader View required! Switch to Reader View first.',true);return}showMsg('üîÑ Extracting...');log('Reader view confirmed');var title='';var selectors=['h1','.title','[class*=title]','[data-testid*=title]'];for(var i=0;i<selectors.length;i++){try{var el=document.querySelector?document.querySelector(selectors[i]):null;if(el&&el.textContent&&el.textContent.trim().length>3){title=el.textContent.trim();log('Found title with: '+selectors[i]);break}}catch(e){log('Error with selector '+selectors[i]+': '+e.message)}}if(!title&&document.title){title=document.title.replace(/\s*[-|]\s*.*$/,'').trim();log('Using document title')}if(!title){showMsg('‚ùå No title found',true);return}log('Title: '+title.substring(0,50));var content='';var textContent='';var contentSels=['article','[role="main"]','.content','.article-content','.post-content','main','body'];var foundContent=false;for(var j=0;j<contentSels.length;j++){try{var cel=document.querySelector?document.querySelector(contentSels[j]):null;if(cel){content=cel.innerHTML||'';textContent=cel.textContent||'';if(textContent.trim().length>50){log('Found content with: '+contentSels[j]);foundContent=true;break}}}catch(e){log('Error with content selector: '+e.message)}}if(!foundContent){if(document.body){content=document.body.innerHTML||'';textContent=document.body.textContent||'';log('Using body content')}else{showMsg('‚ùå No content found',true);return}}var cleanText=(textContent||'').replace(/\s+/g,' ').replace(/[\u00A0\u2000-\u200B\u2028-\u2029\u202F\u205F\u3000]/g,' ').trim();var words=cleanText?cleanText.split(/\s+/).filter(function(w){return w&&w.length>0}):[];var wordCount=words.length;log('Word count: '+wordCount);if(wordCount<10){showMsg('‚ùå Too few words: '+wordCount,true);return}if(cleanText.length<50){showMsg('‚ùå Content too short: '+cleanText.length,true);return}var origUrl='';try{var metaEls=['meta[property="og:url"]','meta[name="twitter:url"]','link[rel="canonical"]'];for(var k=0;k<metaEls.length;k++){var meta=document.querySelector?document.querySelector(metaEls[k]):null;if(meta&&(meta.content||meta.href)){origUrl=meta.content||meta.href;break}}}catch(e){log('Meta URL error: '+e.message)}if(!origUrl&&document.title){var match=document.title.match(/https?:\/\/[^\s]+/);if(match)origUrl=match[0]}if(!origUrl){origUrl=prompt('Please paste the original article URL:',window.location.href)||window.location.href}var author='';try{var authEl=document.querySelector?document.querySelector('[class*=author], .byline, [rel=author]'):null;if(authEl&&authEl.textContent)author=authEl.textContent.trim()}catch(e){log('Author error: '+e.message)}var data={url:origUrl,title:title,author:author||null,publishDate:new Date().toISOString(),content:content,textContent:cleanText,wordCount:wordCount,readingTime:Math.ceil(wordCount/200)*1000,tags:'reader-view'};log('Sending data...');var xhr=new XMLHttpRequest();xhr.open('POST','http://127.0.0.1:3002/api/articles',true);xhr.setRequestHeader('Content-Type','application/json');xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){showMsg('‚úÖ Saved! '+wordCount+' words, '+Math.ceil(wordCount/200)+' min read')}else{showMsg('‚ùå Save failed: HTTP '+xhr.status,true)}}};xhr.send(JSON.stringify(data))}catch(e){showMsg('‚ùå Error: '+e.message,true);console.error('Bookmarklet error:',e)}})();
        </div>
        
        <button class="button" onclick="copyToClipboard()">üìã Copy Code</button>
    </div>
    
    <div class="step">
        <h3>Step 3: Test</h3>
        <ol>
            <li>Make sure server is running: <code>./start.sh</code></li>
            <li>Visit any article (try news.ycombinator.com)</li>
            <li><strong>Switch to Reader View</strong></li>
            <li>Click your bookmark</li>
            <li>Check console for detailed logs</li>
        </ol>
    </div>
    
    <div class="success">
        <strong>üõ°Ô∏è Safety Features:</strong><br>
        ‚Ä¢ Null-safe DOM queries<br>
        ‚Ä¢ Try-catch around every operation<br>
        ‚Ä¢ Detailed console logging<br>
        ‚Ä¢ Graceful fallbacks for missing elements<br>
        ‚Ä¢ Better error messages
    </div>

    <script>
        function copyToClipboard() {
            const codeElement = document.getElementById('bookmarkletCode');
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Copied!';
            button.style.background = '#28a745';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#007aff';
            }, 2000);
        }
    </script>
</body>
</html>