<!DOCTYPE html>
<html>
<head>
    <title>📖 Reader View Bookmarklet Setup</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-box {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            word-break: break-all;
            margin: 10px 0;
        }
        .button {
            background: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>📖 Reader View Bookmarklet Manual Setup</h1>
    
    <div class="success">
        <strong>✅ Manual Installation Required</strong><br>
        Due to Safari's security restrictions, we need to manually create the bookmarklet.
    </div>
    
    <div class="step">
        <h3>Step 1: Create a New Bookmark</h3>
        <ol>
            <li>In Safari, go to <strong>Bookmarks → Add Bookmark</strong></li>
            <li>Set the name to: <strong>📖 Save Article</strong></li>
            <li>Set the URL to any temporary value (we'll change it next)</li>
            <li>Click <strong>Add</strong></li>
        </ol>
    </div>
    
    <div class="step">
        <h3>Step 2: Edit the Bookmark</h3>
        <ol>
            <li>Go to <strong>Bookmarks → Edit Bookmarks</strong></li>
            <li>Find your "📖 Save Article" bookmark</li>
            <li>Click to edit the Address/URL field</li>
            <li>Replace the entire URL with the code below:</li>
        </ol>
        
        <div class="code-box" id="bookmarkletCode">
javascript:(function(){console.log('📖 Reader View Bookmarklet Started');function showNotification(message,isError=false){const notification=document.createElement('div');notification.style.cssText=`position:fixed;top:20px;right:20px;background:${isError?'#f44336':'#4CAF50'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:300px;`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>notification.remove(),4000)}function detectReaderView(){return window.location.protocol==='safari-reader:'||document.body.classList.contains('safari-reader')||document.querySelector('body[data-safari-reader]')||window.location.href.includes('safari-reader://')}function getOriginalURL(){const metaUrl=document.querySelector('meta[property="og:url"]')?.content||document.querySelector('meta[name="twitter:url"]')?.content||document.querySelector('link[rel="canonical"]')?.href;if(metaUrl)return metaUrl;const titleMatch=document.title.match(/https?:\/\/[^\s]+/);if(titleMatch)return titleMatch[0];const userUrl=prompt('📖 Reader View detected! Please paste the original article URL:',window.location.href);return userUrl||window.location.href}function extractContent(){const isReader=detectReaderView();console.log('🔍 Reader view detected:',isReader);if(isReader){showNotification('📖 Reader View detected, adapting...');console.log('📖 Processing reader view content...');const titleSelectors=['h1','.title','[class*=title]','[data-testid*=title]'];let title=null;for(const selector of titleSelectors){const el=document.querySelector(selector);if(el&&el.textContent.trim().length>3){title=el.textContent.trim();console.log(`📝 Found title with selector ${selector}:`,title.substring(0,50));break}}if(!title){title=document.title.replace(/\s*[-|]\s*.*$/,'').trim();console.log('📝 Fallback to document title:',title.substring(0,50))}const contentSelectors=['article','[role="main"]','.content','.article-content','.post-content','main','body'];let contentEl=null;for(const selector of contentSelectors){const el=document.querySelector(selector);if(el){console.log(`📄 Found content with selector: ${selector}`);contentEl=el;break}}const content=contentEl?contentEl.innerHTML:document.body.innerHTML;const textContent=contentEl?contentEl.textContent:document.body.textContent;console.log('📄 Content extraction stats:',{htmlLength:content.length,textLength:textContent.length,selector:contentEl?.tagName+(contentEl?.className?'.'+contentEl.className:'')});const originalUrl=getOriginalURL();console.log('🔗 Original URL resolved:',originalUrl);return{url:originalUrl,title:title,content:content,textContent:textContent.trim(),isReaderView:true}}else{console.log('🌐 Processing regular page content...');console.log('⚠️ Non-reader page detected - skipping as per requirements');throw new Error('This bookmarklet only works with Reader View pages. Please switch to Reader View first.')}}try{showNotification('🔄 Starting article save...');console.log('📖 Reader View Compatible Bookmarklet - Starting extraction');const extracted=extractContent();console.log('🔍 Raw extraction result:',{url:extracted.url,title:extracted.title,contentLength:extracted.content?.length||0,textContentLength:extracted.textContent?.length||0,isReaderView:extracted.isReaderView});const cleanText=extracted.textContent.replace(/\s+/g,' ').replace(/[\u00A0\u2000-\u200B\u2028-\u2029\u202F\u205F\u3000]/g,' ').trim();console.log('🧹 Cleaned text preview:',cleanText.substring(0,200)+'...');const wordCount=cleanText.split(/\s+/).filter(w=>w.length>0).length;console.log('📊 Word count:',wordCount);const author=document.querySelector('[class*=author], .byline, [rel=author]')?.textContent||null;const articleData={url:extracted.url,title:extracted.title,author:author?author.trim():null,publishDate:new Date().toISOString(),content:extracted.content,textContent:cleanText,wordCount:wordCount,readingTime:Math.ceil(wordCount/200)*1000,tags:extracted.isReaderView?'reader-view':null};console.log('📄 Final article data:',{...articleData,content:articleData.content?.substring(0,100)+'...',textContent:articleData.textContent?.substring(0,100)+'...'});if(!articleData.title||articleData.title.length<3){console.error('❌ Title validation failed:',articleData.title);throw new Error('Could not extract article title')}if(!articleData.textContent||articleData.textContent.length<50){console.error('❌ Content validation failed - too short:',articleData.textContent?.length);throw new Error('Article content too short to be meaningful')}if(wordCount<10){console.error('❌ Word count validation failed:',wordCount);throw new Error('Article has too few words')}showNotification('📡 Saving to Reading Tracker...');const endpoints=['https://127.0.0.1:3003/api/articles','http://127.0.0.1:3002/api/articles'];let saved=false;for(const endpoint of endpoints){try{console.log(`🔗 Attempting to save via ${endpoint}`);const response=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(articleData)});console.log(`📡 Response status: ${response.status} ${response.statusText}`);if(response.ok){const result=await response.json();console.log('✅ Article saved successfully:',result);showNotification(`✅ Article saved! ${wordCount} words, ${Math.ceil(wordCount/200)} min read`);saved=true;break}else{const errorText=await response.text();console.error(`❌ Server error (${response.status}):`,errorText)}}catch(e){console.error(`❌ Failed to save via ${endpoint}:`,e.message);continue}}if(!saved){throw new Error('Could not connect to Reading Tracker API')}}catch(error){console.error('Bookmarklet error:',error);showNotification(`❌ Error: ${error.message}`,true)}})();
        </div>
        
        <button class="button" onclick="copyToClipboard()">📋 Copy Code to Clipboard</button>
    </div>
    
    <div class="step">
        <h3>Step 3: Test the Bookmarklet</h3>
        <ol>
            <li>Make sure your Reading Tracker server is running: <code>node main.js</code></li>
            <li>Visit any news article (try news.ycombinator.com)</li>
            <li>Switch to Reader View in Safari</li>
            <li>Click your "📖 Save Article" bookmark</li>
            <li>Open Web Inspector (Develop → Show Web Inspector → Console) to see logs</li>
        </ol>
    </div>
    
    <div class="success">
        <strong>✅ Expected Behavior:</strong><br>
        • Only works in Reader View (will error on regular pages)<br>
        • Shows notifications for progress and success/failure<br>
        • Logs detailed extraction info to console<br>
        • Validates content quality before saving
    </div>

    <script>
        function copyToClipboard() {
            const codeElement = document.getElementById('bookmarkletCode');
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅ Copied!';
            button.style.background = '#28a745';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#007aff';
            }, 2000);
        }
    </script>
</body>
</html>